# 08_ネットワークフローアルゴリズム

節点と辺からなるネットワークについての問題を解くアルゴリズム。

<details><summary>ネットワークフローの定義</summary>

ネットワークを有向グラフでモデル化する

+ G: グラフ。$`G = (V, E)`$
  + すべての節点が連結されている必要はないが、浮島はない想定
+ V: 節点の集合
+ E: 辺の集合
+ s: ソース節点。商品の生産を行う特別な節点。$`s \in V`$
+ t: シンク節点。商品の消費を行う特別な節点。$`t \in V`$
+ e: 辺。
  + $`e \in E, e = (u, v)`$
    + $`u \in V, v \in V`$
  + フローfと容量cを持ち、`f/c`の表記で表される。
  + 例) $`5/10`$ -> 容量が10で、フローが5。
+ c: 辺が持つ容量。
  + $`c = c(e), c = c(u, v)`$
  + $`0 \leqq c`$
+ f: 辺が持つフロー(現在の流通量)。
  + $`f = f(e), f = f(u, v)`$。
  + $`0 \leqq f(e) \leqq c(e)`$
+ ネットワーク経路
  + 閉路ではない異なる節点列とEに含まれるn - 1個の連続した辺からなる経路
  + 辺の方向が無視できる

容量制約

+ $`f(e) \geqq 0`$
+ $`c(e) \geqq 0`$
+ $`0 \leqq f(e) \leqq c(e)`$
+ 辺$`(u, v)`$が存在しない場合、$`c(u, v) = 0`$

フロー保存

+ ソースとシンクをのぞく辺Uに対して、$`\sum f(v, u) = \sum f(u, w)`$
  + $`u,v,w \in U`$
  + $`u \in V, u \notin s, u \notin t`$
  + 測定の辺へ入るフローと出てゆくフローの総数は一致する。(消費されない)

反対称性

+ $`f(u, v) = -f(v, u)`$

</details>

解く問題

+ 割り当て問題(Assignment)
  + 一連の作業に対して作業員を割り当てる場合の全体コスト最小化
+ 二部マッチング問題(Bipartile Matching)
  + 資格が必要な作業に資格を満たす人数割り当ての最大化
+ 最大フロー問題(Maximum Flow)
  + 拠点間の流通量最大化
+ 輸送問題(Transportation)
  + 拠点間の流通コスト最小化
+ 積み替え問題(Transshipment)
  + 拠点間の積み替えコスト最小化

それぞれの問題を解くに当たって、基本となるのが線形計画法(LP)

```mermaid
flowchart LR;

id1[汎用線形計画法]
id2[最小コストフロー問題]
id3[最大フロー問題]
id4[二部マッチング問題]
id5[積み替え問題]
id6[輸送問題]
id7[割り当て問題]

id1 --> id2
id2 --> id3
id3 --> id4
id5 --> id2
id6 --> id7
id5 --> id6
```

+ 汎用線形計画法(LP)
  + シンプレックスアルゴリズムを用いた汎用解。$`Ax <= b,  x >= 0`$の時、目標関数$`\sum (c^t x)`$を最小化する。
+ 割り当て問題(Assignment)
  + 供給節点は1ユニット生産。需要節点は1ユニット消費。需要を満たすのが目標。
+ 二部マッチング問題(Bipartile Matching)
  + ソース節点がシンク節点にマッチする。辺の容量が1。対の個数を最大化するのが目標。
+ 最大フロー問題(Maximum Flow)
  + 単一のソース節点が複数ユニットを配布節点経由でシンク節点に到達するように流す。各辺には容量と実際のフローが付随する。ネットワークフロー$`\sum flow(e)`$を最大化するのが目標。
+ 輸送問題(Transportation)
  + 複数ユニットが供給節点から需要節点に流れる。すべての需要を満たした上でトータルコスト最小化するのが目標。
+ 積み替え問題(Transshipment)
  + 複数ユニットが供給節点から需要節点もしくは積み替え用の節点に流れる。需要を満たし、すべての辺でかかるコストと積み替えにかかるコストの総和を最小化する。
+ 最小コストフロー問題
  + 供給節点が複数ユニットを配布節点のネットワークに流す。需要節点で消費。各辺には容量・実フロー・1ユニット当たりのコストが不随する。需要のすべてを満たしながら全辺での総コスト$`\sum flow(e) * cost(e)`$を最小化する。

## 最大フロー

ソースからシンクへの最大フローを計算する。増加道を見つけてゆき、増加道がなくなると停止する。

+ フォード-ファルカールソン法: 深さ優先探索
+ エドモンズ・カープ法: 幅優先探索

条件
+ すべての有向辺`e`に対して$`c(u, v) \geqq 0`$が与えられている
  + $`e \in E`$

+ 経路
  + `V`からのn個の節点の系列で作られる。
    + $`(p_0, p_1, ..., p_{n-1})`$
    + $`p_0`$: ソース節点
    + $`p_{n-1}`$: シンク節点
  + 前方辺と後方辺からなる
  + 前方辺: 連結した節点の辺が$`(p_i, p_{i+1}) \in E`$
  + 後方辺: 連結した節点の辺が$`(p_{i + 1}, p_i) \in E`$

例) 初期グラフ

```mermaid
stateDiagram-v2
  direction LR

  state "s" as s
  state "1" as v1
  state "2" as v2
  state "3" as v3
  state "4" as v4
  state "t" as t

  s --> v1: 0/3
  s --> v2: 0/2
  v1 --> v4: 0/2
  v2 --> v4: 0/3
  v1 --> v3: 0/2
  v2 --> v3: 0/2
  v3 --> t: 0/3
  v4 --> t: 0/2
```

最大フロー設定済みのグラフ

```mermaid
stateDiagram-v2
  direction LR

  state "s" as s
  state "1" as v1
  state "2" as v2
  state "3" as v3
  state "4" as v4
  state "t" as t

  s --> v1: 3/3
  s --> v2: 2/2
  v1 --> v4: 1/2
  v2 --> v4: 1/3
  v1 --> v3: 2/2
  v2 --> v3: 1/2
  v3 --> t: 3/3
  v4 --> t: 2/2
```

## 二部マッチング

業務と人を資格でマッチさせるアルゴリズムを取り扱う。問題帰着として知られており、二部マッチング問題は最大フロー問題に帰着する。

+ 問題: 要素$`s_i \in S`$を$`t_j \in T`$に関係付ける。出力はPから選ばれた$`(s_i, t_j)`$の部分集合であり、対の最大個数を求める。
+ P: $`p_k \in P`$
  + SとTの対応を表す。
  + ex) $`p_k = (s_i, t_j)`$
+ S: $`s_i \in S`$
  + n個の要素を持つ。
+ T: $`t_j \in T`$
  + m個のパートナーを持つ。

フローネットワークグラフ$`G = (V, E)`$を下記の様に構築する。

+ V: $`n + m + 2`$個の頂点を持つ
  + 各要素$`s_i`$を$`i`$という番号の接点に対応させる($`S`$節点)
  + パートナー$`t_j`$を番号$`n + j`$の設定に対応させる($`T`$節点)
  + ソース節点を番号$`0`$で追加する
  + シンク節点を番号$`n + m + 1`$で追加する
+ E: $`n + m + k`$個の辺を持つ
  + ソース節点から$`S`$節点へのn個の辺
  + $`T`$節点からシンク節点へのm個の辺
  + 各$`p_k = (s_i, t_j)`$に対応する辺$`(i, n + j)`$
  + 全ての辺の容量は0。

例)

業務: $`s_i \in S, 0 \leqq i \leqq n`$ 

| 業務名 | 必要資格 |
| :---- | :----- |
| 事務 | 簿記 |
| エンジニア | 高校卒業資格 |
| 社長 | 金持ち|

人: $`t_j \in T, 0 \leqq j \leqq m`$ 

| 名前 | 保持資格 |
| :----- | :----- |
| A | 簿記,高校卒業資格,金持ち |
| B | 高校卒業資格 |
| C | 金持ち |
| D | エンジニア,高校卒業資格  |

関連: $`p_k \in P, `$

| 業務 | 人 |
| :---- | :---- |
| 事務 | A |
| エンジニア | A |
| エンジニア | B |
| エンジニア | D |
| 社長 | A |
| 社長 | C |

構築されるグラフ

```mermaid
stateDiagram-v2
  direction LR

  state "source" as s
  state "事務" as s1
  state "エンジニア" as s2
  state "社長" as s3
  state "A" as t1
  state "B" as t2
  state "C" as t3
  state "D" as t4
  state "shink" as t

  s --> s1: 0/1
  s --> s2: 0/1
  s --> s3: 0/1
  t1 --> t: 0/1
  t2 --> t: 0/1
  t3 --> t: 0/1
  t4 --> t: 0/1
  s1 --> t1: 0/1
  s2 --> t1: 0/1
  s2 --> t2: 0/1
  s2 --> t4: 0/1
  s3 --> t1: 0/1
  s3 --> t3: 0/1
```

## 最小コストフロー

最小コストフロー問題は最大フローに帰着する。ネットワークの各辺$`(u, v)`$に対して、辺$`(u, v)`$上で1ユニットを輸送するのにかかるコスト$`d(u, v)`$を考えたとき、目標はフローネットワーク全ての辺について$`\sum f(u, v) * d(u, v)`$を最小化する事となる。最大フローでは増加道を求める処理だったが、コストが最も低い増加道を求めることになる。

既出の制約に加え、供給充足と需要充足の制約が加わる。

+ 容量制約(既出)
+ フロー保存(既出)
+ 反対称性(既出)
+ 供給充足
  + 全てのソース節点$`s_i \in S`$において、$`(a - b) \leqq sup(s_i)`$が成り立つ
    + a: ソース節点から出てゆく全ての辺の和$`\sum f(s_i, v)`$, $`(s_i, v) \in E`$
    + b: ソース節点へ入る全ての辺の和$`\sum f(u, s_i)`$, $`(u, s_i) \in E`$
  + $`sup(s_i)`$は$`s_i`$から出るネットワークフローの上限である。
+ 需要充足
  + 全てのシンク節点$`t_j \in T`$において、$`(a - b) \leqq dem(t_j)`$が成り立つ
    + a: シンク節点へ入る全ての辺の和$`\sum f(u, t_j)`$, $`(u, t_j) \in E`$
    + b: シンク節点から出てゆく全ての辺の和$`\sum f(t_j, u)`$, $`(t_j, u) \in E`$
  + $`dem(t_j)`$は$`t_j`$へ入るネットワークフローの上限である。

問題を簡単にするため、複数のソース・シンクを持つグラフに対して単一のソースとシンクを追加して対処する。

+ 追加するソース: $`s_0`$
  + 追加される辺: $`(s_0, s_i) \in E`$
  + 追加される辺の容量: $`c(s_0, s_i) = sup(s_i)`$
  + 追加される辺のコスト: $`d(s_0, s_i) = 0`$
+ 追加するシンク: $`t_0`$
  + 追加される辺$`(t_j, t_0) \in E`$
  + 追加される辺の容量: $`c(t_j, t_0) = dem(t_j)`$
  + 追加される辺のコスト: $`d(t_j, t_0) = 0`$
